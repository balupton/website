String.prototype.toInteger=String.prototype.toInteger||function(){return parseInt(String(this).replace(/px$/,"")||0,10)};String.prototype.toFloat=String.prototype.toInteger||function(){return parseFloat(String(this).replace(/px$/,"")||0,10)};Number.prototype.toInteger=Number.prototype.toInteger||String.prototype.toInteger;Number.prototype.toFloat=Number.prototype.toFloat||String.prototype.toFloat;
jQuery.fn.increase=jQuery.fn.increase||function(a){var b=jQuery(this),e=b.css(a).toFloat(),d=Math.round((e||1)*1.2);e==d&&d++;b.css(a,d);return b};jQuery.fn.decrease=jQuery.fn.decrease||function(a){var b=jQuery(this),e=b.css(a).toFloat(),d=Math.round((e||0)*0.8);e==d&&d>0&&d--;b.css(a,d);return b};GENTICS.Aloha.Image=new GENTICS.Aloha.Plugin("com.gentics.aloha.plugins.Image");GENTICS.Aloha.Image.languages=["en","fr","de"];GENTICS.Aloha.Image.config={img:{max_width:"50px",max_height:"50px"}};
GENTICS.Aloha.Image.init=function(){if(GENTICS.Aloha.Image.settings.objectTypeFilter!=undefined)GENTICS.Aloha.Image.objectTypeFilter=GENTICS.Aloha.Image.settings.objectTypeFilter;if(GENTICS.Aloha.Image.settings.dropEventHandler!=undefined)GENTICS.Aloha.Image.dropEventHandler=GENTICS.Aloha.Image.settings.dropEventHandler;this.initImage();this.bindInteractions();this.subscribeEvents();stylePath=GENTICS_Aloha_base+"/plugins/com.gentics.aloha.plugins.Image/style.css";jQuery('<link rel="stylesheet" />').attr("href",
stylePath).appendTo("head")};GENTICS.Aloha.Image.objectTypeFilter=[];
GENTICS.Aloha.Image.initImage=function(){var a=this;this.insertImgButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_img_insert",size:"small",onclick:function(){a.insertImg()},tooltip:a.i18n("button.addimg.tooltip"),toggle:false});GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.insertImgButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.insert"),1);GENTICS.Aloha.FloatingMenu.createScope(this.getUID("image"),"global");var b=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_img_align_left",
size:"small",onclick:function(){var c=a.findImgMarkup();jQuery(c).css("float","left")},tooltip:a.i18n("button.img.align.left.tooltip")}),e=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_img_align_right",size:"small",onclick:function(){var c=a.findImgMarkup();jQuery(c).css("float","right")},tooltip:a.i18n("button.img.align.right.tooltip")}),d=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_img_align_none",size:"small",onclick:function(){var c=a.findImgMarkup();jQuery(c).css("float",
"")},tooltip:a.i18n("button.img.align.none.tooltip")});new GENTICS.Aloha.ui.Button({label:a.i18n("field.img.src.label"),tooltip:a.i18n("field.img.src.tooltip"),size:"small"});this.imgSrcField=new GENTICS.Aloha.ui.AttributeField({});this.imgSrcField.setObjectTypeFilter(this.objectTypeFilter);new GENTICS.Aloha.ui.Button({label:a.i18n("field.img.title.label"),tooltip:a.i18n("field.img.title.tooltip"),size:"small"});this.imgTitleField=new GENTICS.Aloha.ui.AttributeField;this.imgTitleField.setObjectTypeFilter();
GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),this.imgSrcField,this.i18n("floatingmenu.tab.img"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),e,this.i18n("floatingmenu.tab.img"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),b,this.i18n("floatingmenu.tab.img"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),d,this.i18n("floatingmenu.tab.img"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),this.imgTitleField,this.i18n("floatingmenu.tab.img"),
1);b=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_img_padding_increase",size:"small",onclick:function(){var c=a.findImgMarkup();Image=jQuery(c);Image.increase("padding")},tooltip:this.i18n("padding.increase")});GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),b,this.i18n("floatingmenu.tab.img"),2);b=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_img_padding_decrease",size:"small",onclick:function(){var c=a.findImgMarkup();Image=jQuery(c);Image.decrease("padding")},
tooltip:this.i18n("padding.decrease")});GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),b,this.i18n("floatingmenu.tab.img"),2);b=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_img_size_increase",size:"small",onclick:function(){var c=a.findImgMarkup();Image=jQuery(c);Image.increase("height").increase("width")},tooltip:this.i18n("size.increase")});GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),b,this.i18n("floatingmenu.tab.img"),2);b=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_img_size_decrease",
size:"small",onclick:function(){var c=a.findImgMarkup();Image=jQuery(c);Image.decrease("height").decrease("width")},tooltip:a.i18n("size.decrease")});GENTICS.Aloha.FloatingMenu.addButton(this.getUID("image"),b,this.i18n("floatingmenu.tab.img"),2)};GENTICS.Aloha.Image.bindInteractions=function(){var a=this;this.imgSrcField.addListener("keyup",function(){a.srcChange()});this.imgSrcField.addListener("blur",function(b){img=jQuery(b.getTargetObject());img.attr("src")==""&&img.remove()})};
GENTICS.Aloha.Image.subscribeEvents=function(){var a=this;GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"UploadSuccess",function(e,d){if(d.file.type.match(/image\//)){img=jQuery("#"+d.id);img.attr("src",d.src);img.attr("id","")}});GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"UploadFailure",function(e,d){if(d.file.type.match(/image\//)){img=jQuery("#"+d.id);img.remove()}});GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"dropFileInEditable",function(e,d){if(d.fileObj.file.type.match(/image\//)){var c=
new FileReader;c.config=a.getEditableConfig(d.editable);c.attachedData=d;c.onloadend=function(f){img=jQuery('<img id="'+c.attachedData.fileObj.id+'" style="" title="" src=""></img>');img.click(GENTICS.Aloha.Image.clickImage);if(c.attachedData.fileObj.src==undefined)c.attachedData.fileObj.src=f.target.result;img.attr("src",c.attachedData.fileObj.src);GENTICS.Utils.Dom.insertIntoDOM(img,c.attachedData.range,jQuery(GENTICS.Aloha.activeEditable.obj))};c.readAsDataURL(d.fileObj.file)}});GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,
"selectionChanged",function(e,d){var c=a.findImgMarkup(d);if(a.getEditableConfig(GENTICS.Aloha.activeEditable.obj).img){a.insertImgButton.show();if(c){a.insertImgButton.hide();GENTICS.Aloha.FloatingMenu.setScope(a.getUID("image"));a.imgSrcField.setTargetObject(c,"src");a.imgTitleField.setTargetObject(c,"title");a.imgSrcField.focus();GENTICS.Aloha.FloatingMenu.userActivatedTab=a.i18n("floatingmenu.tab.img")}else a.imgSrcField.setTargetObject(null)}else a.insertImgButton.hide();GENTICS.Aloha.FloatingMenu.doLayout()});
for(var b=0;b<GENTICS.Aloha.editables.length;b++)GENTICS.Aloha.editables[b].obj.find("img").each(function(){jQuery(this).click(GENTICS.Aloha.Image.clickImage)})};GENTICS.Aloha.Image.clickImage=function(){thisimg=jQuery(this);var a=new GENTICS.Utils.RangeObject({startContainer:thisimg.parent(),endContainer:thisimg.parent(),startOffset:1,endOffset:2});a.correctRange();a.update();console.log(a);a.select()};
GENTICS.Aloha.Image.findImgMarkup=function(a){if(typeof a=="undefined")a=GENTICS.Aloha.Selection.getRangeObject();try{if(a.startContainer)if(a.startContainer.childNodes)if(a.startOffset)if(a.startContainer.childNodes[a.startOffset])if(a.startContainer.childNodes[a.startOffset].nodeName.toLowerCase()=="img"){result=a.startContainer.childNodes[a.startOffset];if(!result.css)result.css="";if(!result.title)result.title="";if(!result.src)result.src="";return result}}catch(b){GENTICS.Aloha.Log.debug(b,"Error finding img markup.")}return null};
GENTICS.Aloha.Image.insertImg=function(){var a=GENTICS.Aloha.Selection.getRangeObject();if(a.isCollapsed()){imagetag='<img src="'+GENTICS_Aloha_base+'plugins/com.gentics.aloha.plugins.Image/images/blank.jpeg" title="" style=""></img>';var b=jQuery(imagetag);b.click(GENTICS.Aloha.Image.clickImage);GENTICS.Utils.Dom.insertIntoDOM(b,a,jQuery(GENTICS.Aloha.activeEditable.obj))}else alert("img cannot markup a selection")};GENTICS.Aloha.Image.srcChange=function(){};
