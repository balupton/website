GENTICS.Aloha.TablePlugin=new GENTICS.Aloha.Plugin("com.gentics.aloha.plugins.Table");GENTICS.Aloha.TablePlugin.createLayer=undefined;GENTICS.Aloha.TablePlugin.languages=["en","de","fr","eo","fi","ru","it","pl"];GENTICS.Aloha.TablePlugin.config=["table"];GENTICS.Aloha.TablePlugin.TableRegistry=[];GENTICS.Aloha.TablePlugin.activeTable=undefined;
GENTICS.Aloha.TablePlugin.parameters={className:"GENTICS_Aloha_Table",classSelectionRow:"GENTICS_Aloha_Table_selectColumn",classSelectionColumn:"GENTICS_Aloha_Table_selectRow",classLeftUpperCorner:"GENTICS_Aloha_Table_leftUpperCorner",classTableWrapper:"GENTICS_Aloha_Table_wrapper",classCellSelected:"GENTICS_Aloha_Cell_selected",waiRed:"GENTICS_WAI_RED",waiGreen:"GENTICS_WAI_GREEN",selectionArea:10};
GENTICS.Aloha.TablePlugin.init=function(){this.createLayer=new GENTICS.Aloha.Table.CreateLayer;var a=this;GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"editableCreated",function(b,c){c.obj.bind("mousedown",function(){GENTICS.Aloha.TablePlugin.setFocusedTable(undefined)});c.obj.find("table").each(function(){if(a.isEditableTable(this)){var d=new GENTICS.Aloha.Table(this);d.parentEditable=c;GENTICS.Aloha.TablePlugin.TableRegistry.push(d)}})});this.initTableButtons();GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,
"selectionChanged",function(b,c){if(GENTICS.Aloha.activeEditable){var d=a.getEditableConfig(GENTICS.Aloha.activeEditable.obj);jQuery.inArray("table",d)!=-1&&GENTICS.Aloha.Selection.mayInsertTag("table")?a.createTableButton.show():a.createTableButton.hide();GENTICS.Aloha.TableHelper.unselectCells();if(c.findMarkup(function(){return this.nodeName.toLowerCase()=="table"},GENTICS.Aloha.activeEditable.obj))GENTICS.Aloha.FloatingMenu.setScope(a.getUID(GENTICS.Aloha.TableHelper.selectionType));else a.activeTable&&
a.activeTable.focusOut();GENTICS.Aloha.FloatingMenu.doLayout()}});GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,"editableActivated",function(b,c){c.editable.obj.find("table").each(function(){for(var d=GENTICS.Aloha.TablePlugin.TableRegistry,e=0;e<d.length;e++)if(d[e].obj.attr("id")==jQuery(this).attr("id")){d[e].activate();return true}if(a.isEditableTable(this)){d=new GENTICS.Aloha.Table(this);d.parentEditable=c.editable;d.activate();GENTICS.Aloha.TablePlugin.TableRegistry.push(d)}})});GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha,
"editableDeactivated",function(){GENTICS.Aloha.TablePlugin.setFocusedTable(undefined);GENTICS.Aloha.TableHelper.unselectCells();for(var b=GENTICS.Aloha.TablePlugin.TableRegistry,c=0;c<b.length;c++)b[c].deactivate()})};GENTICS.Aloha.TablePlugin.isEditableTable=function(a){return jQuery(a.parentNode).contentEditable()=="true"?true:false};
GENTICS.Aloha.TablePlugin.initTableButtons=function(){var a=this;GENTICS.Aloha.FloatingMenu.createScope(this.getUID("row"),"GENTICS.Aloha.global");GENTICS.Aloha.FloatingMenu.createScope(this.getUID("column"),"GENTICS.Aloha.global");GENTICS.Aloha.FloatingMenu.createScope(this.getUID("cell"),"GENTICS.Aloha.continuoustext");this.createTableButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_table",size:"small",tooltip:this.i18n("button.createtable.tooltip"),onclick:function(b){GENTICS.Aloha.TablePlugin.createDialog(b.btnEl.dom)}});
GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",this.createTableButton,GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.insert"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("column"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_addColumnLeft",size:"small",tooltip:this.i18n("button.addcolleft.tooltip"),onclick:function(){a.activeTable&&a.activeTable.addColumnsLeft()}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("column"),
new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_addColumnRight",size:"small",tooltip:this.i18n("button.addcolright.tooltip"),onclick:function(){a.activeTable&&a.activeTable.addColumnsRight()}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("column"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_deleteColumns",size:"small",tooltip:this.i18n("button.delcols.tooltip"),onclick:function(){if(a.activeTable){var b=
a.activeTable;GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:GENTICS.Aloha.i18n(a,"Table"),text:GENTICS.Aloha.i18n(a,"deletecolumns.confirm"),type:GENTICS.Aloha.Message.Type.CONFIRM,callback:function(c){c=="yes"&&b.deleteColumns()}}))}}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("row"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_addRowBefore",size:"small",tooltip:this.i18n("button.addrowbefore.tooltip"),
onclick:function(){a.activeTable&&a.activeTable.addRowsBefore(true)}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("row"),new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_addRowAfter",size:"small",tooltip:this.i18n("button.addrowafter.tooltip"),onclick:function(){a.activeTable&&a.activeTable.addRowsAfter(true)}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1);GENTICS.Aloha.FloatingMenu.addButton(this.getUID("row"),
new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_deleteRows",size:"small",tooltip:this.i18n("button.delrows.tooltip"),onclick:function(){if(a.activeTable){var b=a.activeTable;GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:GENTICS.Aloha.i18n(a,"Table"),text:GENTICS.Aloha.i18n(a,"deleterows.confirm"),type:GENTICS.Aloha.Message.Type.CONFIRM,callback:function(c){c=="yes"&&b.deleteRows()}}))}}}),GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1);this.captionButton=new GENTICS.Aloha.ui.Button({iconClass:"GENTICS_button GENTICS_button_table_caption",
size:"small",tooltip:this.i18n("button.caption.tooltip"),toggle:true,onclick:function(){if(a.activeTable)if(a.activeTable.obj.children("caption").is("caption"))a.activeTable.obj.children("caption").remove();else{var b=a.i18n("empty.caption"),c=jQuery("<caption></caption>");a.activeTable.obj.append(c);a.makeCaptionEditable(c,b);b=c.find("div").eq(0);c=b.contents().eq(0);if(c.length>0){var d=new GENTICS.Utils.RangeObject;d.startContainer=d.endContainer=c.get(0);d.startOffset=0;d.endOffset=c.text().length;
a.activeTable.obj.find("div.GENTICS_Table_Cell_editable").blur();b.focus();d.select();GENTICS.Aloha.Selection.updateSelection()}}}});GENTICS.Aloha.FloatingMenu.addButton(this.getUID("cell"),this.captionButton,GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),1);this.summary=new GENTICS.Aloha.ui.AttributeField({width:350});this.summary.addListener("keyup",function(){a.activeTable.checkWai()});GENTICS.Aloha.FloatingMenu.addButton(this.getUID("cell"),this.summary,GENTICS.Aloha.i18n(this,"floatingmenu.tab.table"),
1)};GENTICS.Aloha.TablePlugin.makeCaptionEditable=function(a,b){var c=a.children("div").eq(0);if(c.length==0){c=jQuery("<div></div>");if(a.contents().length>0)a.contents().wrap(c);else{b&&c.text(b);a.append(c)}}c.contentEditable(true);c.unbind("mousedown");c.bind("mousedown",function(d){c.focus();d.preventDefault();d.stopPropagation();return false})};GENTICS.Aloha.TablePlugin.createDialog=function(a){this.createLayer.set("target",a);this.createLayer.show()};
GENTICS.Aloha.TablePlugin.createTable=function(a,b){if(GENTICS.Aloha.activeEditable!=null&&typeof GENTICS.Aloha.activeEditable.obj!="undefined"){for(var c=document.createElement("table"),d=c.id=GENTICS.Aloha.TableHelper.getNewTableID(),e=document.createElement("tbody"),f=0;f<b;f++){for(var h=document.createElement("tr"),g=0;g<a;g++){var k=document.createTextNode("\u00a0"),j=document.createElement("td");j.appendChild(k);h.appendChild(j)}e.appendChild(h)}c.appendChild(e);GENTICS.Utils.Dom.insertIntoDOM(jQuery(c),
GENTICS.Aloha.Selection.getRangeObject(),jQuery(GENTICS.Aloha.activeEditable.obj));c=document.getElementById(d);var l=new GENTICS.Aloha.Table(c);l.parentEditable=GENTICS.Aloha.activeEditable;l.activate();jQuery.browser.msie?window.setTimeout(function(){l.cells[0].wrapper.get(0).focus()},20):l.cells[0].wrapper.get(0).focus();GENTICS.Aloha.TablePlugin.TableRegistry.push(l)}else this.error("There is no active Editable where the table can be inserted!")};
GENTICS.Aloha.TablePlugin.setFocusedTable=function(a){for(var b=0;b<GENTICS.Aloha.TablePlugin.TableRegistry.length;b++)GENTICS.Aloha.TablePlugin.TableRegistry[b].hasFocus=false;if(typeof a!="undefined"){this.summary.setTargetObject(a.obj,"summary");if(a.obj.children("caption").is("caption")){this.captionButton.setPressed(true);this.makeCaptionEditable(a.obj.children("caption"))}a.hasFocus=true}GENTICS.Aloha.TablePlugin.activeTable=a};
GENTICS.Aloha.TablePlugin.error=function(a){GENTICS.Aloha.Log.error(this,a)};GENTICS.Aloha.TablePlugin.debug=function(a){GENTICS.Aloha.Log.debug(this,a)};GENTICS.Aloha.TablePlugin.info=function(a){GENTICS.Aloha.Log.info(this,a)};GENTICS.Aloha.TablePlugin.log=function(a){GENTICS.Aloha.log("log",this,a)};GENTICS.Aloha.TablePlugin.get=function(a){if(this.config[a])return this.config[a];if(this.parameters[a])return this.parameters[a]};
GENTICS.Aloha.TablePlugin.set=function(a,b){if(this.config[a])this.config[a]=b;else this.parameters[a]=b};GENTICS.Aloha.TablePlugin.makeClean=function(a){a.find("table").each(function(){(new GENTICS.Aloha.Table(this)).deactivate()})};GENTICS.Aloha.TablePlugin.toString=function(){return this.prefix};
GENTICS.Aloha.Table=function(a){this.obj=jQuery(a);this.obj.attr("id")||this.obj.attr("id",GENTICS.Utils.guid());a=this.obj.find("tr");this.numCols=jQuery(a.get(0)).children("td, th").length;this.numRows=a.length;this.cells=[];a=this.obj.find("tr");for(var b=0;b<a.length;b++)for(var c=jQuery(a[b]).children(),d=0;d<c.length;d++)this.cells.push(new GENTICS.Aloha.Table.Cell(c[d],this))};GENTICS.Aloha.Table.prototype.obj=undefined;GENTICS.Aloha.Table.prototype.tableWrapper=undefined;
GENTICS.Aloha.Table.prototype.cells=undefined;GENTICS.Aloha.Table.prototype.numRows=undefined;GENTICS.Aloha.Table.prototype.numCols=undefined;GENTICS.Aloha.Table.prototype.isActive=false;GENTICS.Aloha.Table.prototype.hasFocus=false;GENTICS.Aloha.Table.prototype.parentEditable=undefined;GENTICS.Aloha.Table.prototype.mousedown=false;GENTICS.Aloha.Table.prototype.clickedColumnId=-1;GENTICS.Aloha.Table.prototype.clickedRowId=-1;GENTICS.Aloha.Table.prototype.columnsToSelect=[];
GENTICS.Aloha.Table.prototype.rowsToSelect=[];GENTICS.Aloha.Table.prototype.fmPluginId=undefined;GENTICS.Aloha.Table.prototype.get=function(a){return GENTICS.Aloha.TablePlugin.get(a)};GENTICS.Aloha.Table.prototype.set=function(a,b){GENTICS.Aloha.TablePlugin.set(a,b)};
GENTICS.Aloha.Table.prototype.activate=function(){if(!this.isActive){var a=this;this.obj.addClass(this.get("className"));this.obj.contentEditable(false);this.obj.attr("id")==""&&this.obj.attr("id",GENTICS.Aloha.TableHelper.getNewTableID());GENTICS.Aloha.TableHelper.selectionType=undefined;this.obj.bind("keydown",function(c){!c.ctrlKey&&!c.shiftKey&&GENTICS.Aloha.TableHelper.selectedCells.length>0&&GENTICS.Aloha.TableHelper.selectedCells[0].length>0&&GENTICS.Aloha.TableHelper.selectedCells[0][0].firstChild.focus()});
this.obj.bind("mousedown",function(c){a.hasFocus||a.focus();c.stopPropagation();c.preventDefault();return false});var b=jQuery('<div class="'+this.get("classTableWrapper")+'"></div>');b.contentEditable(false);this.obj.wrap(b);b=this.obj.parents("."+this.get("classTableWrapper"));b.get(0).onresizestart=function(){return false};b.get(0).oncontrolselect=function(){return false};this.tableWrapper=this.obj.parents("."+this.get("classTableWrapper")).get(0);jQuery(this.cells).each(function(){this.activate()});
this.attachSelectionColumn();this.attachSelectionRow();this.attachLastCellEvents();this.makeCaptionEditable();this.checkWai();this.isActive=true;GENTICS.Aloha.EventRegistry.trigger(new GENTICS.Aloha.Event("tableActivated",GENTICS.Aloha,[this]))}};GENTICS.Aloha.Table.prototype.makeCaptionEditable=function(){var a=this.obj.find("caption").eq(0);a&&GENTICS.Aloha.TablePlugin.makeCaptionEditable(a)};
GENTICS.Aloha.Table.prototype.checkWai=function(){var a=this.wai;a.removeClass(this.get("waiGreen"));a.removeClass(this.get("waiRed"));this.obj[0].summary.length>5?a.addClass(this.get("waiGreen")):a.addClass(this.get("waiRed"))};
GENTICS.Aloha.Table.prototype.attachSelectionColumn=function(){var a=jQuery("<td>");a.html("\u00a0");for(var b=this.obj.context.rows,c=0;c<b.length;c++){var d=jQuery(b[c]),e=a.clone();e.addClass(this.get("classSelectionColumn"));e.css("width",this.get("selectionArea")+"px");d.find("td:first").before(e);this.attachRowSelectionEventsToCell(e)}};
GENTICS.Aloha.Table.prototype.attachRowSelectionEventsToCell=function(a){var b=this;a.unbind("mousedown");a.unbind("mouseover");a.get(0).onselectstart=function(){return false};a.bind("mousedown",function(c){b.mousedown=true;return b.rowSelectionMouseDown(c)});a.bind("mouseover",function(c){if(b.mousedown)return b.rowSelectionMouseOver(c)})};
GENTICS.Aloha.Table.prototype.rowSelectionMouseDown=function(a){this.focus();if(GENTICS.Aloha.TableHelper.selectedCells.length==0)this.rowsToSelect=[];this.clickedRowId=a.currentTarget.parentNode.rowIndex;if(a.metaKey){var b=jQuery.inArray(this.clickedRowId,this.rowsToSelect);b>=0?this.rowsToSelect.splice(b,1):this.rowsToSelect.push(this.clickedRowId)}else if(a.shiftKey){this.rowsToSelect.sort(function(d,e){return d-e});var c=this.rowsToSelect[0];b=this.clickedRowId;if(c>b){c=b;b=this.rowsToSelect[0]}this.rowsToSelect=
[];for(c=c;c<=b;c++)this.rowsToSelect.push(c)}else this.rowsToSelect=[this.clickedRowId];this.selectRows();a.preventDefault();a.stopPropagation();return false};
GENTICS.Aloha.Table.prototype.rowSelectionMouseOver=function(a){var b=a.currentTarget.parentNode.rowIndex;if(this.mousedown&&this.clickedRowId>=0){jQuery.inArray(b,this.rowsToSelect);var c=b<this.clickedRowId?b:this.clickedRowId;b=b<this.clickedRowId?this.clickedRowId:b;this.rowsToSelect=[];for(c=c;c<=b;c++)this.rowsToSelect.push(c);this.selectRows();a.preventDefault();a.stopPropagation();return false}};
GENTICS.Aloha.Table.prototype.attachSelectionRow=function(){var a=this,b=jQuery("<td>");b.html("\u00a0");var c=this.obj.context.rows[0].cells.length,d=jQuery("<tr>");d.addClass(this.get("classSelectionRow"));d.css("height",this.get("selectionArea")+"px");for(var e=0;e<c;e++){var f=b.clone();if(e>0)this.attachColumnSelectEventsToCell(f);else{f=jQuery("<td>").clone();f.addClass(this.get("classLeftUpperCorner"));this.wai=jQuery("<div/>");this.wai.width(25);this.wai.height(12);this.wai.click(function(h){a.focus();
GENTICS.Aloha.FloatingMenu.userActivatedTab=GENTICS.Aloha.TablePlugin.i18n("floatingmenu.tab.table");GENTICS.Aloha.FloatingMenu.doLayout();GENTICS.Aloha.TablePlugin.summary.focus();h.stopPropagation();h.preventDefault();return false});f.append(this.wai)}d.append(f)}jQuery(document).bind("mouseup",function(){a.mousedown=false;a.clickedColumnId=-1;a.clickedRowId=-1});this.obj.find("tr:first").before(d)};
GENTICS.Aloha.Table.prototype.attachColumnSelectEventsToCell=function(a){var b=this;a.unbind("mousedown");a.unbind("mouseover");a.get(0).onselectstart=function(){return false};a.bind("mousedown",function(c){b.mousedown=true;b.columnSelectionMouseDown(c)});a.bind("mouseover",function(c){b.mousedown&&b.columnSelectionMouseOver(c)})};
GENTICS.Aloha.Table.prototype.columnSelectionMouseDown=function(a){this.focus();if(GENTICS.Aloha.TableHelper.selectedCells.length==0)this.columnsToSelect=[];this.clickedColumnId=a.currentTarget.cellIndex;if(a.metaKey){var b=jQuery.inArray(this.clickedColumnId,this.columnsToSelect);b>=0?this.columnsToSelect.splice(b,1):this.columnsToSelect.push(this.clickedColumnId)}else if(a.shiftKey){this.columnsToSelect.sort(function(d,e){return d-e});var c=this.columnsToSelect[0];b=this.clickedColumnId;if(c>b){c=
b;b=this.columnsToSelect[0]}this.columnsToSelect=[];for(c=c;c<=b;c++)this.columnsToSelect.push(c)}else this.columnsToSelect=[this.clickedColumnId];this.selectColumns();a.preventDefault();a.stopPropagation();return false};
GENTICS.Aloha.Table.prototype.columnSelectionMouseOver=function(a){var b=a.currentTarget.cellIndex;if(this.mousedown&&this.clickedColumnId>0){jQuery.inArray(b,this.columnsToSelect);a=b<this.clickedColumnId?b:this.clickedColumnId;b=b<this.clickedColumnId?this.clickedColumnId:b;this.columnsToSelect=[];for(a=a;a<=b;a++)this.columnsToSelect.push(a);this.selectColumns()}};GENTICS.Aloha.Table.prototype.releaseLastCellEvents=function(){this.obj.find("tr:last td:last").unbind()};
GENTICS.Aloha.Table.prototype.attachLastCellEvents=function(){var a=this;this.obj.find("tr:last td:last").bind("keydown",function(b){a.lastCellKeyDown(b)})};GENTICS.Aloha.Table.prototype.lastCellKeyDown=function(a){if(9==a.keyCode&&!a.altKey&&!a.shiftKey&&!a.ctrlKey){this.addRowsAfter(false);a.stopPropagation();if(jQuery.browser.msie){this.obj.find("tr:last td:nth-child(1) div.GENTICS_Table_Cell_editable").get(0).focus();return false}}};
GENTICS.Aloha.Table.prototype.deleteRows=function(){var a=[],b=false;if(GENTICS.Aloha.TableHelper.selectedCells.length>0)for(var c=0;c<GENTICS.Aloha.TableHelper.selectedCells.length;c++)a.push(GENTICS.Aloha.TableHelper.selectedCells[c][0].parentNode.rowIndex);else typeof GENTICS.Aloha.Table.Cell.lastActiveCell!="undefined"&&a.push(GENTICS.Aloha.Table.Cell.lastActiveCell.obj.context.parentNode.rowIndex);if(a.length==this.numRows)b=true;if(b){var d=this;GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:GENTICS.Aloha.i18n(GENTICS.Aloha.TablePlugin,
"Table"),text:GENTICS.Aloha.i18n(GENTICS.Aloha.TablePlugin,"deletetable.confirm"),type:GENTICS.Aloha.Message.Type.CONFIRM,callback:function(g){g=="yes"&&d.deleteTable()}}))}else{a.sort(function(g,k){return g-k});b=a[0];b>this.numRows-a.length&&b--;this.releaseLastCellEvents();var e=this.obj.find("tr"),f=[];for(c=0;c<a.length;c++)f.push(jQuery(e[a[c]]));for(c=0;c<f.length;c++){a=f[c].children("td").toArray();for(e=0;e<a.length;e++)for(var h=0;h<this.cells.length;h++)if(a[e]==this.cells[h].obj.get(0)){this.cells.splice(h,
1);h=this.cells.length}}for(c=0;c<f.length;c++)f[c].remove();this.numRows-=f.length;jQuery.browser.msie?setTimeout(this.obj.find("tr:nth-child("+(b+1)+") td:nth-child(2) div.GENTICS_Table_Cell_editable").get(0).focus,5):this.obj.find("tr:nth-child("+(b+1)+") td:nth-child(2) div.GENTICS_Table_Cell_editable").get(0).focus();this.attachLastCellEvents();GENTICS.Aloha.TableHelper.unselectCells()}};
GENTICS.Aloha.Table.prototype.deleteColumns=function(){var a=[],b=false;if(GENTICS.Aloha.TableHelper.selectedCells.length>0)for(var c=0;c<GENTICS.Aloha.TableHelper.selectedCells[0].length;c++)a.push(GENTICS.Aloha.TableHelper.selectedCells[0][c].cellIndex);else typeof GENTICS.Aloha.Table.Cell.lastActiveCell!="undefined"&&a.push(GENTICS.Aloha.Table.Cell.lastActiveCell.obj.context.cellIndex);if(a.length==this.numCols)b=true;if(b){var d=this;GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:GENTICS.Aloha.i18n(GENTICS.Aloha.TablePlugin,
"Table"),text:GENTICS.Aloha.i18n(GENTICS.Aloha.TablePlugin,"deletetable.confirm"),type:GENTICS.Aloha.Message.Type.CONFIRM,callback:function(k){k=="yes"&&d.deleteTable()}}))}else{a.sort(function(k,j){return k-j});b=a[0];b>this.numCols-a.length&&b--;this.releaseLastCellEvents();var e=this.obj.find("tr"),f=[];for(c=0;c<e.length;c++)for(var h=jQuery(e[c]).children("td").toArray(),g=0;g<a.length;g++)f.push(h[a[g]]);for(c=0;c<f.length;c++)for(g=0;g<this.cells.length;g++)if(f[c]==this.cells[g].obj.get(0)){this.cells.splice(g,
1);g=this.cells.length}for(c=0;c<f.length;c++)jQuery(f[c]).remove();this.numCols-=a.length;jQuery.browser.msie?setTimeout(this.obj.find("tr:nth-child(2) td:nth-child("+(b+1)+") div.GENTICS_Table_Cell_editable").get(0).focus,5):this.obj.find("tr:nth-child(2) td:nth-child("+(b+1)+") div.GENTICS_Table_Cell_editable").get(0).focus();this.attachLastCellEvents();GENTICS.Aloha.TableHelper.unselectCells()}};
GENTICS.Aloha.Table.prototype.deleteTable=function(){for(var a=-1,b=0;b<GENTICS.Aloha.TablePlugin.TableRegistry.length;b++)if(GENTICS.Aloha.TablePlugin.TableRegistry[b].obj.attr("id")==this.obj.attr("id")){a=b;break}if(a>=0){this.deactivate();GENTICS.Aloha.TableHelper.selectionType=undefined;GENTICS.Aloha.TablePlugin.TableRegistry.splice(b,1);a=GENTICS.Aloha.Selection.rangeObject;a.startContainer=a.endContainer=this.obj.get(0).parentNode;a.startOffset=a.endOffset=GENTICS.Utils.Dom.getIndexInParent(this.obj.get(0).parentNode);
a.clearCaches();this.obj.remove();this.parentEditable.obj.focus();a.correctRange();a.select()}};GENTICS.Aloha.Table.prototype.addRowsBefore=function(a){this.addRows("before",a)};GENTICS.Aloha.Table.prototype.addRowsAfter=function(a){this.addRows("after",a)};
GENTICS.Aloha.Table.prototype.addRows=function(a,b){if(typeof GENTICS.Aloha.TablePlugin.activeTable!="undefined"){this.releaseLastCellEvents();var c=this.numCols,d=1,e=1;if(GENTICS.Aloha.TableHelper.selectedCells.length>0){d=GENTICS.Aloha.TableHelper.selectedCells.length;switch(a){case "before":if(GENTICS.Aloha.TableHelper.selectedCells[0].length)e=GENTICS.Aloha.TableHelper.selectedCells[0][0].parentNode.rowIndex;break;case "after":var f=GENTICS.Aloha.TableHelper.selectedCells.length-1;if(GENTICS.Aloha.TableHelper.selectedCells[f].length)e=
GENTICS.Aloha.TableHelper.selectedCells[f][0].parentNode.rowIndex;break}}else if(typeof GENTICS.Aloha.Table.Cell.lastActiveCell!="undefined")e=GENTICS.Aloha.Table.Cell.lastActiveCell.obj.context.parentNode.rowIndex;f=e;if(a=="after")f+=1;for(var h=[],g=0;g<d;g++){h.push(f);var k=jQuery("<tr>"),j=jQuery("<td>");j.addClass(this.get("classSelectionColumn"));this.attachRowSelectionEventsToCell(j);k.append(j);for(i=0;i<c;i++){j=jQuery("<td>");j.html("\u00a0");j=new GENTICS.Aloha.Table.Cell(j.get(0),GENTICS.Aloha.TablePlugin.activeTable);
j.activate();this.cells.push(j);k.append(j.obj)}j=jQuery(GENTICS.Aloha.TablePlugin.activeTable.obj.find("tr").get(e));switch(a){case "before":j.before(k);break;case "after":j.after(k);break;default:this.warn(this,"Wrong call of GENTICS.Aloha.Table.prototype.addRow!")}f++;this.numRows++}GENTICS.Aloha.TableHelper.unselectCells();this.rowsToSelect=h;b&&this.selectRows();this.attachLastCellEvents()}};GENTICS.Aloha.Table.prototype.addColumnsRight=function(){this.addColumns("right")};
GENTICS.Aloha.Table.prototype.addColumnsLeft=function(){this.addColumns("left")};
GENTICS.Aloha.Table.prototype.addColumns=function(a){if(typeof GENTICS.Aloha.TablePlugin.activeTable!="undefined"){this.releaseLastCellEvents();var b=1,c=1;if(GENTICS.Aloha.TableHelper.selectedCells.length>0){b=GENTICS.Aloha.TableHelper.selectedCells[0].length;switch(a){case "left":if(GENTICS.Aloha.TableHelper.selectedCells[0].length)c=GENTICS.Aloha.TableHelper.selectedCells[0][0].cellIndex;break;case "right":var d=GENTICS.Aloha.TableHelper.selectedCells[0].length-1;if(GENTICS.Aloha.TableHelper.selectedCells[0].length)c=
GENTICS.Aloha.TableHelper.selectedCells[0][d].cellIndex;break}}else if(typeof GENTICS.Aloha.Table.Cell.lastActiveCell!="undefined")c=GENTICS.Aloha.Table.Cell.lastActiveCell.obj.context.cellIndex;c=c;d=jQuery("<td>");for(var e=this.obj.find("tr"),f=[],h=0;h<e.length;h++)for(var g=c,k=e[h],j=0;j<b;j++){var l=d.clone();l.html("\u00a0");if(h==0)this.attachColumnSelectEventsToCell(l);else{cellObj=new GENTICS.Aloha.Table.Cell(l.get(0),GENTICS.Aloha.TablePlugin.activeTable);this.cells.push(cellObj);cellObj.activate();
l=cellObj.obj}var m=jQuery(jQuery(k).find("td").get(c));switch(a){case "left":jQuery.inArray(g,f)<0&&f.push(g);m.before(l);break;case "right":jQuery.inArray(g+1,f)<0&&f.push(g+1);m.after(l);break}g++}this.numCols+=b;GENTICS.Aloha.TableHelper.unselectCells();this.columnsToSelect=f;this.selectColumns();this.attachLastCellEvents()}};GENTICS.Aloha.Table.prototype.focus=function(){if(!this.hasFocus){this.parentEditable.isActive||this.parentEditable.obj.focus();GENTICS.Aloha.TablePlugin.setFocusedTable(this)}};
GENTICS.Aloha.Table.prototype.focusOut=function(){if(this.hasFocus){GENTICS.Aloha.TablePlugin.setFocusedTable(undefined);GENTICS.Aloha.TableHelper.selectionType=undefined}};
GENTICS.Aloha.Table.prototype.selectColumns=function(){var a=this.get("classCellSelected");GENTICS.Aloha.TableHelper.unselectCells();GENTICS.Aloha.TableHelper.selectionType="column";GENTICS.Aloha.FloatingMenu.setScope(GENTICS.Aloha.TablePlugin.getUID("column"));this.columnsToSelect.sort(function(k,j){return k-j});var b=this.obj.find("tr").toArray();b.shift();for(var c=[],d=0;d<b.length;d++){for(var e=b[d].cells,f=[],h=0;h<this.columnsToSelect.length;h++){var g=e[this.columnsToSelect[h]];c.push(g);
f.push(g)}GENTICS.Aloha.TableHelper.selectedCells.push(f)}this.obj.find("div.GENTICS_Table_Cell_editable").blur();jQuery(c).addClass(a)};
GENTICS.Aloha.Table.prototype.selectRows=function(){this.get("classCellSelected");GENTICS.Aloha.TableHelper.unselectCells();this.rowsToSelect.sort(function(c,d){return c-d});for(var a=0;a<this.rowsToSelect.length;a++){var b=this.rowsToSelect[a];b=jQuery(this.obj.find("tr").get(b).cells).toArray();b.shift();GENTICS.Aloha.TableHelper.selectedCells.push(b);jQuery(b).addClass(this.get("classCellSelected"))}GENTICS.Aloha.TableHelper.selectionType="row";GENTICS.Aloha.FloatingMenu.setScope(GENTICS.Aloha.TablePlugin.getUID("row"));
this.obj.find("div.GENTICS_Table_Cell_editable").blur()};
GENTICS.Aloha.Table.prototype.deactivate=function(){this.obj.removeClass(this.get("className"));GENTICS.Aloha.trim(this.obj.attr("class"))==""&&this.obj.removeAttr("class");this.obj.parents("."+this.get("classTableWrapper")).length&&this.obj.unwrap();this.obj.find("tr."+this.get("classSelectionRow")+":first").remove();var a=this;jQuery.each(this.obj.context.rows,function(){jQuery(this).children("td."+a.get("classSelectionColumn")).remove()});this.obj.find("td, th").removeClass(this.get("classCellSelected"));
this.obj.unbind();for(var b=0;b<this.cells.length;b++)this.cells[b].deactivate();this.obj.find("caption div").each(function(){jQuery(this).contents().unwrap()});this.isActive=false};GENTICS.Aloha.Table.prototype.toString=function(){return"GENTICS.Aloha.Table"};GENTICS.Aloha.Table.Cell=function(a,b){this.obj=jQuery(a);this.tableObj=b};GENTICS.Aloha.Table.Cell.prototype.tableObj=undefined;GENTICS.Aloha.Table.Cell.prototype.obj=undefined;GENTICS.Aloha.Table.Cell.prototype.wrapper=undefined;
GENTICS.Aloha.Table.Cell.prototype.hasFocus=false;GENTICS.Aloha.Table.Cell.activeCell=undefined;GENTICS.Aloha.Table.Cell.lastActiveCell=undefined;GENTICS.Aloha.Table.Cell.prototype.editableFocus=function(){if(!this.hasFocus){this.tableObj.focus();GENTICS.Aloha.Table.Cell.activeCell=this;GENTICS.Aloha.Table.Cell.lastActiveCell=this;this.obj.addClass("GENTICS_Table_Cell_active");this.hasFocus=true;this.selectAll(this.wrapper.get(0));GENTICS.Aloha.TableHelper.selectionType="cell"}};
GENTICS.Aloha.Table.Cell.prototype.editableBlur=function(){GENTICS.Aloha.Table.Cell.activeCell=undefined;this.hasFocus=false;this.obj.removeClass("GENTICS_Table_Cell_active")};
GENTICS.Aloha.Table.Cell.prototype.activate=function(){this.obj.wrapInner("<div/>");var a=this.obj.children("div").eq(0);a.contentEditable(true);a.addClass("GENTICS_Table_Cell_editable");var b=this;a.bind("focus",function(c){if(c.currentTarget)c.currentTarget.indexOf=function(){return-1};b.editableFocus(c)});a.bind("mousedown",function(c){if(c.currentTarget)c.currentTarget.indexOf=function(){return-1};b.editableMouseDown(c)});a.bind("blur",function(c){b.editableBlur(c)});a.bind("keyup",function(c){b.editableKeyUp(c)});
a.bind("keydown",function(c){b.editableKeyDown(c)});a.GENTICS_contentEditableSelectionChange(function(c){GENTICS.Aloha.Selection.onChange(a,c);return a});this.obj.bind("mousedown",function(c){setTimeout(function(){b.wrapper.trigger("focus")},1);GENTICS.Aloha.TableHelper.unselectCells();c.stopPropagation()});this.obj.get(0).onselectstart=function(){return false};this.wrapper=this.obj.children();this.wrapper.get(0).onselectstart=function(){window.event.cancelBubble=true};return this};
GENTICS.Aloha.Table.Cell.prototype.deactivate=function(){var a=this.obj.children(".GENTICS_Table_Cell_editable");if(a.length){var b=a.html();a.unbind();a.remove();this.obj.unbind("click");GENTICS.Aloha.trim(this.obj.attr("class"))==""&&this.obj.removeAttr("class");this.obj.html(b)}};GENTICS.Aloha.Table.Cell.prototype.toString=function(){return"GENTICS.Aloha.Table.Cell"};
GENTICS.Aloha.Table.Cell.prototype.selectAll=function(a){var b=a.jquery?a.get(0):a;if(jQuery.browser.msie)if(document.getSelection){c=document.getSelection();d=document.createRange();d.selectNodeContents(b);c.removeAllRanges();c.addRange(d)}else{if(document.selection){d=document.body.createTextRange();d.moveToElementText(b);d.select()}}else{var c=window.getSelection();if(c.setBaseAndExtent)c.setBaseAndExtent(b,0,b,b.innerText.length-1);else{if(window.opera&&b.innerHTML.substring(b.innerHTML.length-
4)=="<BR>")b.innerHTML+="&#160;";var d=document.createRange();d.selectNodeContents(b);c.removeAllRanges();c.addRange(d)}}GENTICS.Aloha.Selection.updateSelection(a)};GENTICS.Aloha.Table.Cell.prototype.editableMouseDown=function(a){GENTICS.Aloha.TableHelper.unselectCells();this.tableObj.hasFocus&&a.stopPropagation()};GENTICS.Aloha.Table.Cell.prototype.editableKeyUp=function(a){this.checkForEmptyEvent(a)};
GENTICS.Aloha.Table.Cell.prototype.editableKeyDown=function(a){this.checkForEmptyEvent(a);if(!a.ctrlKey&&!a.shiftKey){if(GENTICS.Aloha.TableHelper.selectedCells.length>0&&GENTICS.Aloha.TableHelper.selectedCells[0].length>0){GENTICS.Aloha.TableHelper.selectedCells[0][0].firstChild.focus();GENTICS.Aloha.TableHelper.unselectCells();a.stopPropagation()}}else if(a.shiftKey&&GENTICS.Aloha.TableHelper.selectedCells.length>0){switch(GENTICS.Aloha.TableHelper.selectionType){case "row":switch(a.keyCode){case 38:var b=
GENTICS.Aloha.TableHelper.selectedCells[0][0].parentNode.rowIndex;b>1&&this.tableObj.rowsToSelect.push(b-1);break;case 40:b=GENTICS.Aloha.TableHelper.selectedCells[GENTICS.Aloha.TableHelper.selectedCells.length-1][0].parentNode.rowIndex;b<this.tableObj.numRows&&this.tableObj.rowsToSelect.push(b+1);break}this.tableObj.selectRows();break;case "column":switch(a.keyCode){case 37:b=GENTICS.Aloha.TableHelper.selectedCells[0][0].cellIndex;b>1&&this.tableObj.columnsToSelect.push(b-1);break;case 39:b=GENTICS.Aloha.TableHelper.selectedCells[0][GENTICS.Aloha.TableHelper.selectedCells[0].length-
1].cellIndex;b<this.tableObj.numCols&&this.tableObj.columnsToSelect.push(b+1);break}this.tableObj.selectColumns();break}a.stopPropagation();a.preventDefault();return false}};GENTICS.Aloha.Table.Cell.prototype.checkForEmptyEvent=function(){if(!(jQuery(this.wrapper).children().length>0))if(this.wrapper.text()==""){this.wrapper.text("\u00a0");this.wrapper.get(0).blur();this.wrapper.get(0).focus()}};GENTICS.Aloha.Table.CreateLayer=function(){};
GENTICS.Aloha.Table.CreateLayer.prototype.parameters={elemId:"GENTICS_Aloha_Table_createLayer",className:"GENTICS_Table_Createdialog",numX:10,numY:10,layer:undefined,target:undefined};GENTICS.Aloha.Table.CreateLayer.prototype.config={};GENTICS.Aloha.Table.CreateLayer.prototype.visible=false;GENTICS.Aloha.Table.CreateLayer.prototype.show=function(){var a=this.get("layer");if(a==null)this.create();else{this.setPosition(a);a.find("td").removeClass("hover");a.show()}this.visible=true};
GENTICS.Aloha.Table.CreateLayer.prototype.create=function(){var a=this,b=jQuery("<div></div>");b.id=this.get("elemId");b.addClass(this.get("className"));var c=jQuery("<table></table>");c.css("width",(this.get("numX")+6)*15);for(var d,e,f=0;f<this.get("numY");f++){d=jQuery("<tr></tr>");for(var h=0;h<this.get("numX");h++){e=jQuery("<td>\u00a0</td>");f==0&&h==0&&e.addClass("hover");e.bind("mouseover",{rowId:f,colId:h},function(g){a.handleMouseOver(g,c)});e.bind("click",{rowId:f,colId:h},function(g){GENTICS.Aloha.TablePlugin.createTable(g.data.colId+
1,g.data.rowId+1);a.hide()});d.append(e)}c.append(d)}b.append(c);this.set("layer",b);this.setPosition();b.bind("click",function(g){g.stopPropagation()}).mousedown(function(g){g.stopPropagation()});jQuery("body").append(b).bind("click",function(g){g.target!=a.get("target")&&a.visible&&a.hide()})};
GENTICS.Aloha.Table.CreateLayer.prototype.handleMouseOver=function(a,b){for(var c=a.data.rowId,d=a.data.colId,e=b.find("tr"),f=0;f<=e.length;f++)for(var h=jQuery(e[f]).find("td"),g=0;g<=h.length;g++)f<=c&&g<=d?jQuery(h[g]).addClass("hover"):jQuery(h[g]).removeClass("hover")};GENTICS.Aloha.Table.CreateLayer.prototype.setPosition=function(){var a=jQuery(this.get("target")),b=a.offset();this.get("layer").css("left",b.left+"px");this.get("layer").css("top",b.top+a.height()+"px")};
GENTICS.Aloha.Table.CreateLayer.prototype.hide=function(){this.get("layer").hide();this.visible=false};GENTICS.Aloha.Table.CreateLayer.prototype.get=function(a){if(this.config[a])return this.config[a];if(this.parameters[a])return this.parameters[a]};GENTICS.Aloha.Table.CreateLayer.prototype.set=function(a,b){if(this.config[a])this.config[a]=b;else this.parameters[a]=b};GENTICS.Aloha.TableHelper=function(){};GENTICS.Aloha.TableHelper.prototype.selectionType=undefined;
GENTICS.Aloha.TableHelper.prototype.selectedCells=[];GENTICS.Aloha.TableHelper.prototype.unselectCells=function(){if(this.selectedCells.length>0){for(var a=0;a<this.selectedCells.length;a++)jQuery(this.selectedCells[a]).removeClass(GENTICS.Aloha.TablePlugin.get("classCellSelected"));this.selectedCells=[];this.selectionType=undefined}};
GENTICS.Aloha.TableHelper.prototype.getNewTableID=function(){for(;;this.tableCounter++){for(var a="GENTICS_Table_"+Math.ceil(Math.random()*1E6),b=a.length;b<14+(1E6).toString().length;b++)a+="0";if(!jQuery("#"+a).length)return a}};GENTICS.Aloha.TableHelper=new GENTICS.Aloha.TableHelper;
